locality sender
locality receiver

name channel_secret : nonce

def sent_message @ sender
def sent_message_aad @ sender
type plaintext_t = (x:Data<[channel_secret] /\ adv, |adv|>{happened(sent_message(x))})


name skR : DH @ receiver
name skE<i> : DH @ sender
name skS : DH @ sender

counter send_counter<i> @ sender
counter recv_counter<j> @ receiver

nametype plaintext_enc_t(expand_pre, info) = 
    st_aead plaintext_t
                              aad x. happened(sent_message_aad(x))
                              nonce send_counter
                              pattern i. xor(i, gexpand<nonce |counter|;0>(expand_pre, info))

nametype corr_plaintext_enc_t = 
    st_aead (x:Data<adv>{False})
                              aad x. true
                              nonce send_counter

func hpke_v1() = "hpke-v1"

func hpke_suite_id() = 0x48504b45002000010003 // TODO

func kdfkey_len() = 
    0x0020

func enckey_len() = 
    0x0020

func nonce_len() = 
    0x000c

func psk_id() = (0x)

func mode() = 0x03 // auth_psk

func info() = (0x)

func labeled_info(lbl, info, len) = 
    len ++ hpke_v1() ++ hpke_suite_id() ++ lbl ++ info

func labeled_ikm(lbl, ikm) = 
    hpke_v1() ++ hpke_suite_id() ++ lbl ++ ikm

func base_info(kss) = labeled_info("base_nonce", kss, nonce_len())
func key_info(kss) = labeled_info("key", kss, enckey_len())
func exp_info(kss) = labeled_info("exp", kss, nonce_len())

nametype secret_expand_t = expandkey { info self.
    // ksc = key_schedule_context
    <ksc> length(ksc) == 1 + 2 * |expandkey| /\ info == base_info(ksc) -> // TODO: nonce_len should be counter_len
        public nonce |counter|,
    <ksc>
     length(ksc) == 1 + 2 * |expandkey| /\ info == key_info(ksc) -> 
        strict plaintext_enc_t(self, base_info(ksc)),
    <ksc> length(ksc) == 1 + 2 * |expandkey| 
        /\ info == exp_info(ksc) -> 
        strict nonce
}
        
nametype secret_extract_t = extractkey secret_expand_t
        
nametype dh_shared_secret_expand_t = expandkey {info self. 
    True -> strict secret_extract_t
}

    
odh ss : skR, skS -> dh_shared_secret_expand_t
odh se<i> : skR, skE<i> -> dh_shared_secret_expand_t

name psk : secret_extract_t @ sender, receiver

corr<i> [skE<i>] /\ [skS] /\ [psk] ==> [channel_secret]
corr [skR] /\ [psk] ==> [channel_secret]

struct hpke_ciphertext { 
    hc_pk : Data<adv> | |group| |,
    hc_cipher : Data<adv>
}

predicate secret_dh<i>() = sec(skR) /\ (sec(skS) \/ sec(skE<i>)) 
predicate secret_dh_unauth<i>(e) = sec(skR) /\ (sec(skS) \/ (e == dhpk(get(skE<i>)) /\ sec(skE<i>)))
predicate secret_static_dh() = sec(skR) /\ sec(skS) 
predicate secret_psk_or_dh<i>() = sec(psk) \/ secret_dh<i>[]
