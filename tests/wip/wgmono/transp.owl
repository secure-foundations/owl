include "defs.owl"

def init_recv<i@n,m>(tki : transp_keys_init<session i, pid n, pid m>) @
Initiator<n>
    : Option Data<adv /\ [channel_secret_resp_send<@n,m>]> = 
    input i in 
    parse tki as transp_keys_init<session i, pid n, pid m>(eph, c7, init_send,
    resp_send) in 
    parse i as transp(tag, rcv, ctr, pkt) in {
        pcase init_clean<i,n,m>[eph] in 
        st_aead_dec(resp_send, pkt, 0x, ctr)
    }
    otherwise None()

def init_send<i@n,m>(tki : transp_keys_init<session i, pid n, pid m>,
    msg : Data<adv /\ [channel_secret_init_send<@n,m>], |adv|>
) @
Initiator<n>
    : Unit
    =
    parse tki as transp_keys_init<session i, pid n, pid m>(eph, c7, init_send,
    resp_send) in 
    pcase init_clean<i,n,m>[eph] in 
    let transp_counter = get_counter N_init_send<i@n> in
    let rcv = 0x00000000 in // TODO 
    let c = st_aead_enc<N_init_send<i@n>>(init_send, msg, 0x) in 
    let transp_tag = transp_tag_value() in 
    let o = transp(transp_tag, rcv, transp_counter, c) in 
    output o

def resp_recv<j@n,m>(tki_ : exists n_pk. 
    transp_keys_resp<session j, pid n, pid n_pk, pid m>) @
Responder<m>
    : Option Data<adv /\ [channel_secret_init_send<@n,m>]> = 
    input i in 
    unpack n_pk, tki = tki_ in
    parse tki as transp_keys_resp<session j, pid n, pid n_pk, pid m>(eph, c7, init_send,
    resp_send) in 
    parse i as transp(tag, rcv, ctr, pkt) in {
        pcase resp_clean<j,n,n_pk,m>[eph] in 
        st_aead_dec(init_send, pkt, 0x, ctr)
    }
    otherwise None()

def resp_send<j@n,m>(tki_ : exists n_pk. 
    transp_keys_resp<session j, pid n, pid n_pk, pid m>,
    msg : Data<adv /\ [channel_secret_resp_send<@n,m>], |adv|>
    ) @
Responder<m>
    : Unit
 = 
    unpack n_pk, tki = tki_ in
    parse tki as transp_keys_resp<session j, pid n, pid n_pk, pid m>(eph, c7, init_send,
    resp_send) in 
    pcase resp_clean<j,n,n_pk,m>[eph] in 
    let transp_counter = get_counter N_resp_send<j@m> in
    let rcv = 0x00000000 in // TODO 
    let c = st_aead_enc<N_resp_send<j@m>>(resp_send, msg, 0x) in 
    let transp_tag = transp_tag_value() in 
    let o = transp(transp_tag, rcv, transp_counter, c) in 
    output o

